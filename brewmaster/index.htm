<html>
<head>
<title>Winemaker Brewing Station</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
</head>
<body>
<script type="text/javascript">
// Compilation of contract addresses
const WINEMAKER_REWARDS = "0xae1de1c258c5587cfea69045992a5467cff4406f";
const WINEMAKER_PROGRESSION = "0x46840fedbafaf7ad2b9b6395421662ee9279349f";
const VINEYARD = "0x28c65dcB3a5f0d456624AFF91ca03E4e315beE49"

const GRAPE_TOKEN = "0x5541D83EFaD1f281571B343977648B75d95cdAC2";
const MIM_TOKEN = "0x130966628846bfd36ff31a822705796e8cb8c18d";
const VINT_TOKEN = "0x01Af64EF39AEB5612202AA07B3A3829f20c395fd";
const SVINT_TOKEN = "0xf016e69F2c08a0b743a7d815d1059318DCa8Fc0e";

const VINT_LP = "0x1a3b20040dd5c890f247a5fb6c078b9943ffaa40";
const GRAPE_LP = "0xb382247667fe8ca5327ca1fa4835ae77a9907bc8";
// Winemaker game parameter constants
const CHAIN_ID = 43114;
const RESET_MULTI = 1;
const BASE_VPM = .05;
const YIELD_PPS = 833333333333333;

/*
 * Checks for a valid metamask instance and requests the account
 * Returns true if the user connected to the site
 */
const Web3Enabled = async () => {
	if(typeof window.ethereum !== "undefined") {
		await window.ethereum.request({method: 'eth_requestAccounts'}).then(function(result) {
			console.log("[SUCCESS] " + result);
		}, function(error) {
			console.log("[ERROR " + error.code + "] " + error.message);
			return false;
		});

		window.web3 = new Web3(window.ethereum);
		return true;
	} else {
		console.log("Metamask is not installed!");
	}
	return false;
}

/*
 * Checks to make sure we're on the right chain and if not
 * invoke a switch
 */
const switchNetwork = async(chainId) => {
	var currentChainId = window.web3.eth.net.getId();
	if(currentChainId !== chainId) {
		await window.ethereum.request(
		{
			method: 'wallet_switchEthereumChain',
			params: [{ chainId: window.web3.utils.toHex(chainId) }]
		});
	}
}

const getAllowance = async(owner, spender) => {
	// allowance test	
	return await grapeOracle.methods.allowance(owner, spender).call({ from: owner });
}

const getData = async(account) => {
	refreshId = setInterval(function() {
	funcId = window.web3.utils.keccak256("getFatigueAccrued(address)").substring(0,10);
	funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));
	window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(fatigue) {
	
		var fatigueAccrued = fatigue/1e14;			
		document.getElementById("fatigue").innerHTML = (fatigueAccrued*100).toFixed(3) + "%";
		
		funcId = window.web3.utils.keccak256("getTimeUntilFatigued(address)").substring(0,10);
		funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));			
		window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(result) {
		
			var dt30 = new Date(0);
			var dt100 = new Date(0);					
			dt30.setUTCSeconds((Date.now()/1000) + ((result - (Date.now()/1000)) * (0.3-fatigueAccrued)));
			dt100.setUTCSeconds(result);
			document.getElementById("fatiguedate30").innerHTML = dt30.toLocaleDateString() + ", " + dt30.toLocaleTimeString();
			document.getElementById("fatiguedate100").innerHTML = dt100.toLocaleDateString() + ", " + dt100.toLocaleTimeString();
		
		});
		
		funcId = window.web3.utils.keccak256("getTotalPPM(address)").substring(0,10);
		funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));			
		window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(totalPPM) {
			document.getElementById("resetCost").innerHTML = (totalPPM * RESET_MULTI).toFixed(2) + " GRAPE";
			funcId = window.web3.utils.keccak256("getMasterVintnerNumber(address)").substring(0,10);
			funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));			
			window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(masterNumber) {
				funcId = window.web3.utils.keccak256("getMasterVintnerSkillModifier(address,uint256)").substring(0,10);
				funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64)) + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(masterNumber, 64));
				window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_PROGRESSION, data: funcData }]}).then(function(modifier) {
					document.getElementById("masters").innerHTML = window.web3.utils.toNumber(masterNumber) + " vintners";
					funcId = window.web3.utils.keccak256("startTimeStamp(address)").substring(0,10);
					funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));			
					window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(startTime) {
						funcId = window.web3.utils.keccak256("fatiguePerMinute(address)").substring(0,10);
						funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));			
						window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(fatiguePM) {
							funcId = window.web3.utils.keccak256("vintageWineAccruedCalculation(uint256,uint256,uint256,uint256,uint256,uint256,uint256)").substring(0,10);
							funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(0, 64));
							funcData += window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(60, 64));
							funcData += window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(totalPPM, 64));
							funcData += window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(modifier, 64));
							funcData += window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(fatigue, 64));
							funcData += window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(fatiguePM, 64));
							funcData += window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(YIELD_PPS, 64));
							window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(dynamicPPM) {
								document.getElementById("vpm").innerHTML = (dynamicPPM/1e18).toFixed(2) + "/" + (totalPPM * BASE_VPM).toFixed(2);
							});
						});
					});
				});
			});
		});
	});
	
	funcId = window.web3.utils.keccak256("numberOfStaked(address,uint256)").substring(0,10);
	funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64)) + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(0, 64));
	window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(result) {
		document.getElementById("normals").innerHTML = window.web3.utils.toNumber(result) + " vintners";
	});
	
	funcId = window.web3.utils.keccak256("getVintageWineAccrued(address)").substring(0,10);
	funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));			
	window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_REWARDS, data: funcData }]}).then(function(claimable) {
		var vintEarned = (claimable / 1e18);
		
		funcId = window.web3.utils.keccak256("balanceOf(address)").substring(0,10);
		funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(VINT_LP, 64));			
		window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: MIM_TOKEN, data: funcData }]}).then(function(mimSupply) {
			funcId = window.web3.utils.keccak256("balanceOf(address)").substring(0,10);
			funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(VINT_LP, 64));			
			window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: VINT_TOKEN, data: funcData }]}).then(function(vintSupply) {
			
				// Calculate the price of the VINTAGE
				var vintPrice = (mimSupply/vintSupply);
					
				// Update the UI
				document.getElementById("vintage").innerHTML = vintEarned.toFixed(8) + " $VINTAGE";
				document.getElementById("vintagevalue").innerHTML = "$" + (vintEarned * vintPrice).toFixed(2) + " USD";
			
				funcId = window.web3.utils.keccak256("getVintageWineStorage(address)").substring(0,10);
				funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));
				window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: WINEMAKER_PROGRESSION, data: funcData }]}).then(function(result) {
					document.getElementById("storage").innerHTML = vintEarned.toFixed(0) + "/" + (window.web3.utils.toBN(result) / 1e18).toFixed(0);
				});
			
				funcId = window.web3.utils.keccak256("balanceOf(address)").substring(0,10);
				funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(GRAPE_LP, 64));			
				window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: MIM_TOKEN, data: funcData }]}).then(function(mimSupply2) {
				
					funcId = window.web3.utils.keccak256("balanceOf(address)").substring(0,10);
					funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(GRAPE_LP, 64));			
					window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: GRAPE_TOKEN, data: funcData }]}).then(function(grapeSupply) {
						var grapePrice = (mimSupply2/grapeSupply);
						var fiftyGrape = 50 * grapePrice;
						var ratio = (vintPrice / grapePrice) * 100;
						// Update the UI						
						document.getElementById("vintageprice").innerHTML = "$" + (vintPrice).toFixed(4) + " (" + ((vintPrice / grapePrice)*100).toFixed(2) + "%)";
											
						// Update the UI
						document.getElementById("grapeprice").innerHTML = "$" + grapePrice.toFixed(4);
						document.getElementById("grapetovint").innerHTML = (fiftyGrape/vintPrice).toFixed(2) + " $VINTAGE";
						var mag = (20*grapePrice) + (300*vintPrice);
						var shears = (30*grapePrice) + (600*vintPrice);
						var hydro = (80*grapePrice) + (1000*vintPrice);
						document.getElementById("magazine").innerHTML = "$" + mag.toFixed(2) + " ($" + (fiftyGrape - mag).toFixed(2) + ")";
						document.getElementById("shears").innerHTML = "$" + shears.toFixed(2) + " ($" + (fiftyGrape*3 - shears).toFixed(2) + ")<br>"
						document.getElementById("hydro").innerHTML = "$" + hydro.toFixed(2) + " ($" + (fiftyGrape*5 - hydro).toFixed(2) + ")";
					});
				});
			});
		});
	});
	
	/*
	// Wallet VINTAGE balance
	funcId = window.web3.utils.keccak256("balanceOf(address)").substring(0,10);
	funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));			
	window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: VINT_TOKEN, data: funcData }]}).then(function(balance) {
		document.getElementById("vintinwallet").innerHTML = (balance/1e18).toFixed(8) + " $VINTAGE";
	});
	
	// Wallet sVINTAGE balance
	funcId = window.web3.utils.keccak256("balanceOf(address)").substring(0,10);
	funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));			
	window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: SVINT_TOKEN, data: funcData }]}).then(function(balance) {
		document.getElementById("svintinwallet").innerHTML = (balance/1e18).toFixed(8) + " $sVINTAGE";
	});
	
	// Vinyard sVINTAGE balance
	funcId = window.web3.utils.keccak256("userInfo(uint256,address)").substring(0,10);
	funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(7, 64)) + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));
	window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: VINEYARD, data: funcData }]}).then(function(userInfo) {
		document.getElementById("svintinvinyard").innerHTML = (window.web3.utils.toBN(userInfo.substring(2,66))/1e18).toFixed(8) + " $sVINTAGE";
	});
	
	// Vinyard pending WINE
	funcId = window.web3.utils.keccak256("pendingShare(uint256,address)").substring(0,10);
	funcData = funcId + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(7, 64)) + window.web3.utils.stripHexPrefix(window.web3.utils.padLeft(account, 64));
	window.ethereum.request({ method: 'eth_call', params: [{ from: account, to: VINEYARD, data: funcData }]}).then(function(balance) {
		document.getElementById("pendingwine").innerHTML = (balance/1e18).toFixed(8) + " $WINE";
	});*/	
}, 7500);
};

const rpcQuery = async() => {
	window.web3 = new Web3(window.ethereum);
	if(refreshId !== null) {
		clearInterval(refreshId);
	}
	var account = document.getElementById("addressEntry").value;	
	if(account !== "" && window.web3.utils.isAddress(account)) {
		document.getElementById("address").innerHTML = account;
		getData(account);		
	}
};

var refreshId = null;
const web3Query = async () => {
	if(refreshId !== null) {
		clearInterval(refreshId);
	}
	if(await Web3Enabled()) { // Initialize web3 and connected to metamask
		await switchNetwork(CHAIN_ID); // Make sure we're on the c-chain
		
		window.web3.eth.getAccounts().then(function(accounts) {
			document.getElementById("address").innerHTML = accounts[0];
			getData(accounts[0]);
		});
	}
}

const resetFatigue = async() => {	
	window.web3.eth.getAccounts().then(function(result) {		
		var account = result[0];		
		grape.methods.allowance(account, WINEMAKER_REWARDS).call({from: account }).then(function(allowance) {			
			if(window.web3.utils.toBN(allowance).lt(window.web3.utils.toBN("115792089237316195423570985008687907853269984665640564039457584007913129639935"))) {			
				grape.methods.approve(WINEMAKER_REWARDS, "115792089237316195423570985008687907853269984665640564039457584007913129639935").send({ from: account }).then(function() {
					winery.methods.resetFatigue().send({ from: account });
				});
			} else {
				winery.methods.resetFatigue().send({ from: account });
			}
		});		
	});
}

const claimVintage = async() => {	
	window.web3.eth.getAccounts().then(function(result) {		
		var account = result[0];		
		winery.methods.claimVintageWine().send({ from: account });
	});
}

web3Query();
</script>

<!-- inline stylesheet -->
<style>
body {
	
	font-family: consolas;
	background-image: url("https://cloudflare-ipfs.com/ipfs/QmNrSft5ZStreCKgFwxmaYAN1TxyMZ62N9fVkYJXd8K48Y");
	background-attachment: fixed;
	color: #FEFF35;
}

.cardAddress {
	position: absolute;
	background-color: #111111BA;
	height: 50px;
	width: 400px;
	left: 50%;
	top: 10%;
    transform: translate(-50%, -50%);  
	padding: 16px 16px 16px 16px;
}

.cardWinery {
	position: absolute;
	background-color: #111111BA;
	width: 400px;
	left: 50%;
	top: 50%;
    transform: translate(-50%, -50%);  
	padding: 16px 16px 16px 16px;
}

.cardDisclaimer {
	position: absolute;
	background-color: #111111BA;
	width: 700px;
	left: 50%;
	top: 92%;
    transform: translate(-50%, -50%);  
	padding: 16px 16px 16px 16px;
}

.row-header {	
	font-size: 12pt;
}

.title-header {
	font-size: 36px;
	filter: drop-shadow(5px 5px 2px #111111C0);
	font-weight: bold;
	text-align: center;
}

.panel-header {
	font-size: 24px;
	filter: drop-shadow(5px 5px 2px #111111C0);
	font-weight: bold;
	width: 100%;
	margin-top: 8px;
	text-align: center
}

.panel {
	background-color: #333333BA;
	margin-top: 16px;
	margin-left: 8px;
	margin-right: 8px;
	width: 384px;
	border-radius: 16px;
	float: left;	
}

img {
	filter: drop-shadow(3px 3px 5px #FE18D3);
}

.row-item {
	display: flex;
}

.row-header {
	filter: drop-shadow(5px 5px 2px #111111C0);
	font-weight: bold;
	width: 150px;
}

.row-content {
	filter: drop-shadow(5px 5px 2px #111111C0);
	font-weight: bold;
	grow-flex: 1;
}

a {
	color: #018e39;
}

a:hover {
	color: #006636;
}

.button {
	background-color: #018e39;
	text-align: center;
	font-weight: bold;
	margin-top: 8px;
	width: 150px;
	height: 24px;
	filter: drop-shadow(5px 5px 2px #111111C0);
	cursor: pointer;
}

.button:hover {
	background-color: #006636;
}
</style>

<div class="cardAddress" id="cardAddress">
	<div style="position: absolute; width: 0%; left: 50%; top: 50%; transform: translate(-50%, -75%); overflow: visible;">		
		<input id="addressEntry" placeholder="Connect via Metamask, or enter your wallet address" style="width: 325px; transform: translate(-50%, -50%);"></input>
		<div class="button" style="position: absolute; transform: translate(10%, -50%)" onclick="rpcQuery();">Check Address</div>
		<div class="button" style="position: absolute; transform: translate(-110%, -50%)" onclick="web3Query();">Connect</div>
	</div>
</div>

<div class="cardWinery">
	<div class="title-header">&#127863; Brewing Station &#127863;</div>
	<!-- Winery panel -->
	<div class="panel">
		<div class="panel-header">Winery</div>
		<div style="margin: 8px;">
			<div>
				<div class="row-item">
					<div class="row-header" style="width: 110px;">GRAPE:</div>
					<div class="row-content" id="grapeprice"></div>
				</div>
				<div class="row-item">
					<div class="row-header" style="width: 110px;">VINTAGE:</div>
					<div class="row-content" id="vintageprice"></div>
				</div>
			</div>
			<div style="margin-top: 8px">
				<span class="row-header">Brewer Address: </span>
				<span class="row-content"  id="address"></span>
			</div>
			<div style="margin-top: 8px">
				<span class="row-header">Vintage PM:</span>
				<span class="row-content" id="vpm"></span>
			</div>
			<div style="margin-top: 8px">
				<span class="row-header">Max fatigue on </span><span class="row-content" id="fatiguedate100"></span><br>
				<span class="row-header">30% fatigue on </span><span class="row-content" id="fatiguedate30"></span><br>
				<span class="row-header">Current Fatigue: </span><span class="row-content"  id="fatigue"></span>
			</div>
			<div style="margin-top: 8px">
				<span class="row-header">Reset Fatigue Cost: </span><span class="row-content" id="resetCost"></span>
			</div>
			<div id="vintners" style="margin-top: 8px">
				<span class="row-header">Master Vinters Staked: </span><span class="row-content" id="masters"></span><br>
				<span class="row-header">Normal Vinters Staked: </span><span class="row-content" id="normals"></span>
			</div>
			<div style="margin-top: 8px">
				<div class="row-item">
					<div class="row-header" style="width: 150px">Vintage Earned: </div>
					<div class="row-content" id="vintage"></div>
				</div>
				<div class="row-item">
					<div class="row-header" style="width: 150px">Vintage Value:</div>
					<div class="row-content" id="vintagevalue"></div>
				</div>
				<div class="row-item">
					<div class="row-header" style="width: 150px">Storage Used:</div>
					<div class="row-content" id="storage"></div>
				</div>
			</div>
			<div style="margin-top: 8px">
				<span class="row-header">50 GRAPE = </span><span class="row-content" id="grapetovint"></span><br>
			</div>
			<div style="margin-top: 8px">
				<span class="row-header">Tools Mint Costs:</span><br>
				<div class="row-item">
					<div class="row-header" style="width: 130px; text-align: right;">Magazine:&nbsp;</div>
					<div class="row-content" id="magazine"></div>
				</div>
				<div class="row-item">
					<div class="row-header" style="width: 130px; text-align: right;">Shears:&nbsp;</div>
					<div class="row-content" id="shears"></div>
				</div>
				<div class ="row-item">
					<div class="row-header" style="width: 130px; text-align: right;">Hydrometer:&nbsp;</div>
					<div class="row-content" id="hydro"></div>
				</div>
			</div>
			<div style="margin: 16px">
				<div class="button" id="resetButton" onClick="resetFatigue();">Reset Fatigue</div>
				<div class="button" id="claimButton" onClick="claimVintage();">Claim $VINTAGE</div>
			</div>
		</div>
	</div>
	
	<!-- Cellar panel -->
	<!--<div class="panel">
		<div class="panel-header">Cellar Manager</div>
		<div style="margin: 8px;">
			<div>
				<div class="row-header">Wallet:</div>
				<div class="row-item">
					<div class="row-header" style="text-align: right; transform: translate(-16px, 0px)">$VINTAGE: </div>
					<div id="vintinwallet" class="row-content"></div>
				</div>
				<div class="row-item">
					<div class="row-header" style="text-align: right; transform: translate(-16px, 0px)">$sVINTAGE: </div>
					<div id="svintinwallet" class="row-content"></div>
				</div>
				<div style="margin-top: 8px; display: flex;">
					<div style="width: 45%;">
						<div class="button">Deposit $VINTAGE</div>
						<div class="button">Stake $sVINTAGE</div>
					</div>
					<div style="width: 45%; grow-flex: 1;">
						<div class="button">Deposit $VINTAGE</div>
						<div class="button">Stake $sVINTAGE</div>
					</div>
				</div>
			</div>			
			<div style="margin-top: 16px">
				<div class="row-item">
					<div class="row-header">Vineyard: </div>
					<div id="svintinvinyard" class="row-content"></div>
				</div>
				<div class="row-item">
					<div class="row-header">Pending: </div>
					<div id="pendingwine" class="row-content"></div>
				</div>
				<div style="margin-top: 8px">
					<div class="button">Claim Rewards</div>					
				</div>
			</div>
		</div>
	</div> -->
</div>
<div class="cardDisclaimer">
DISCLAIMER: This tool provides a basic interface into the winery to keep track of stats, reset fatigue, and claim your $VINTAGE; it is NOT intended to be a replacement for the winemaker game.<br>
This tool is open-source, you can view the source on the <a href="https://github.com/neoaikon2/WinemakerBrewingStation">GitHub repository</a><br>
<div style="font-size: 12px; margin-top: 4px;">Brewmaster v1.3</div>
</div>
</body>
</html>